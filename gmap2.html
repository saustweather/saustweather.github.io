
<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <title>SA Generators</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
    <script>

      function initMap() {
        $.ajax({
        url : "NEM_DUIDs_with_geo.csv",
        async:false,            //this is the trick
        success : function(result){
                csv=$.csv.toArrays(result);
               }
        });
        $.ajax({
          url: "https://www.dropbox.com/s/fzqhnr39fq45ijh/gen_info.json?raw=1",
          jsonp: "callback",
          dataType: 'jsonp',
          success: function( response ) {
            console.log('response from dropbox:')
            console.log( response ); // server response
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("Status: " + textStatus);
            console.log(XMLHttpRequest);
          }
       });
      //console.log(csv[0][14]);
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 6,
          center: {lat: -34.5, lng: 138.6}
        });

        //var ctaLayer = new google.maps.KmlLayer({
        //  url: 'http://23.239.134.229:7078/placemark.kml?dummy='+(new Date()).getTime(),
        //  map: map
        //});
     //icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
        var infowindow =  new google.maps.InfoWindow;
        var marker,i;
        for (i=1; i<csv.length; i++) {
          if (csv[i][2]=='SA1') {
            //console.log(csv[i][14]+' '+ csv[i][18]+' '+csv[i][19])
            marker = new google.maps.Marker({
         position: new google.maps.LatLng(csv[i][18], csv[i][19]),
         map: map
    });
         google.maps.event.addListener(marker, 'click', (function(marker, i) {
         return function() {
             infowindow.setContent(csv[i][14]);
             infowindow.open(map, marker);
         }
    })(marker, i));
          }
        };

        var marker= new google.maps.Marker({
           sName: "this is a name",
icon: {
        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
        scale: 8.5,
        fillColor: "#9C0000",
        fillOpacity: 0.4,
        strokeWeight: 0.4
    },
           position: new google.maps.LatLng(-34.8,138.5),
           map: map

        });
        google.maps.event.addListener(marker, 'mouseover', function() {
          infowindow.open(map, this);
        });
        google.maps.event.addListener(marker, 'mouseout', function() {
          infowindow.close(map, this);
        });

        //google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|"
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9IEBA9Uqm1leEeKoJf8LwetdAhEA5Qks&callback=initMap">
    </script>
  </body>
</html>
